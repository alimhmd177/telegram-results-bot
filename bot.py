#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ø¨ÙˆØª ØªÙ„ØºØ±Ø§Ù… Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ø¨ÙˆØ§Ø¨Ø© Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±
"""

import os
import logging
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from scraper_selenium import StudentPortalScraper

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)


class StudentBot:
    """ÙØ¦Ø© Ø¨ÙˆØª Ø§Ù„ØªÙ„ØºØ±Ø§Ù…"""
    
    def __init__(self, token):
        self.token = token
    
    async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± /start"""
        welcome_message = """
ğŸ“ *Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨*

Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª ÙŠØ³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬Ùƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ù…Ù† Ø¨ÙˆØ§Ø¨Ø© Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±.

*Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:*
ğŸ“ /get_results - Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬Ùƒ
â“ /help - Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©

*ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:*
1ï¸âƒ£ Ø£Ø±Ø³Ù„ Ø§Ù„Ø£Ù…Ø± /get_results
2ï¸âƒ£ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ
3ï¸âƒ£ Ø£Ø±Ø³Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹: 123456)

Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©!
        """
        await update.message.reply_text(welcome_message, parse_mode='Markdown')
    
    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± /help"""
        help_text = """
ğŸ“š *Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©*

*Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:*

*Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø§Ù„Ø³Ø±ÙŠØ¹Ø©):*
Ø£Ø±Ø³Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ ÙˆØ³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (123456)

Ù…Ø«Ø§Ù„:
`1124693617`

*Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Ù…Ø¹ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø®ØµØµØ©):*
Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ Ø«Ù… ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…ÙØµÙˆÙ„Ø© Ø¨Ù…Ø³Ø§ÙØ©

Ù…Ø«Ø§Ù„:
`1124693617 mypassword`

*Ø§Ù„Ø£ÙˆØ§Ù…Ø±:*
/start - Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
/get_results - Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
/help - Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©

*Ù…Ù„Ø§Ø­Ø¸Ø©:*
ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù‡ÙŠ: 123456
        """
        await update.message.reply_text(help_text, parse_mode='Markdown')
    
    async def get_results(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± /get_results"""
        instructions = """
ğŸ“ *Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬Ùƒ:*

Ø£Ø±Ø³Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ Ø§Ù„Ø¢Ù†.

Ø£Ùˆ Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…ÙØµÙˆÙ„Ø© Ø¨Ù…Ø³Ø§ÙØ©:
`1124693617 123456`
        """
        await update.message.reply_text(instructions, parse_mode='Markdown')
    
    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ©"""
        text = update.message.text.strip()
        
        # ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙØ§Ø±ØºØ©
        if not text:
            return
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø±
        wait_msg = await update.message.reply_text("â³ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†ØªØ§Ø¦Ø¬...\nÙ‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù...")
        
        scraper = None
        try:
            # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            parts = text.split()
            
            if len(parts) == 1:
                # Ø±Ù‚Ù… Ø¬Ø§Ù…Ø¹ÙŠ ÙÙ‚Ø·
                student_id = parts[0]
                password = "123456"
            elif len(parts) == 2:
                # Ø±Ù‚Ù… Ø¬Ø§Ù…Ø¹ÙŠ ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±
                student_id = parts[0]
                password = parts[1]
            else:
                await wait_msg.edit_text(
                    "âŒ ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Ø·Ø¦!\n\n"
                    "Ø£Ø±Ø³Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ ÙÙ‚Ø·ØŒ Ø£Ùˆ:\n"
                    "`Ø±Ù‚Ù…_Ø¬Ø§Ù…Ø¹ÙŠ ÙƒÙ„Ù…Ø©_Ø§Ù„Ù…Ø±ÙˆØ±`",
                    parse_mode='Markdown'
                )
                return
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ
            if not student_id.isdigit():
                await wait_msg.edit_text(
                    "âŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·!"
                )
                return
            
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            scraper = StudentPortalScraper(headless=True)
            data = scraper.get_all_data(student_id, password)
            
            # ØªÙ†Ø³ÙŠÙ‚ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø©
            message = scraper.format_results_message(data)
            await wait_msg.edit_text(message, parse_mode='Markdown')
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {str(e)}")
            await wait_msg.edit_text(
                f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:\n{str(e)}\n\n"
                "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…."
            )
        finally:
            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­
            if scraper:
                try:
                    scraper.close()
                except:
                    pass
    
    def run(self):
        """ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        application = Application.builder().token(self.token).build()
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£ÙˆØ§Ù…Ø±
        application.add_handler(CommandHandler("start", self.start))
        application.add_handler(CommandHandler("help", self.help_command))
        application.add_handler(CommandHandler("get_results", self.get_results))
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ©
        application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_message))
        
        # Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
        logger.info("Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª...")
        application.run_polling(allowed_updates=Update.ALL_TYPES)


def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
    token = os.getenv('TELEGRAM_BOT_TOKEN')
    
    if not token:
        print("âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ TELEGRAM_BOT_TOKEN")
        print("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹ÙŠÙŠÙ† ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©:")
        print("export TELEGRAM_BOT_TOKEN='your_bot_token_here'")
        return
    
    # Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
    bot = StudentBot(token)
    bot.run()


if __name__ == "__main__":
    main()

